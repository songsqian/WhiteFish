```{r}
################# Code for Bernoulli_Bernoulli_Mixture_Model #######################
##################### PACKAGES, RUN SETTINGS, AND DATA #############################

# Data: Import from local directory
Bernoulli_Bernoulli_Mixture_Model_Data <- read.csv("Bernoulli_Bernoulli_Mixture_Model_Data.csv")

# Packages
library(rstan)
library(dplyr)
library(rv)

# Run Settings
rstan_options(auto_write = TRUE)
options(mc.cores = min(c(parallel::detectCores(), 8)))
nchains <- min(c(parallel::detectCores(), 8))
niters <- 50000
nkeep <- 2500
nthin <- ceiling((niters/2) * nchains/nkeep)

################### MODEL ################################
# Bernoulli_Bernoulli_Mixture_Model
Bernoulli_Bernoulli_Mixture_Model <- "
data {
  int<lower=0> Nobs;
  int<lower=0> Nyear;
  int<lower=0,upper=Nyear> year[Nobs];
  int y[Nobs];
  vector[Nobs] Search;
//  real a;
//  real b;
}
parameters {
  vector[Nyear] lconc;
//  real<lower=0,upper=1> r;
  real mu;
  real<lower=0,upper=10> sigma;
}
transformed parameters{
  vector[Nyear] conc;
  real lambda[Nobs];
  for (i in 1:Nobs)
    lambda[i] = exp(lconc[year[i]]) * Search[i];
  conc = exp(lconc);
}
model {
  real temp2[2];
//  r ~ beta(a, b);
  lconc ~ normal(mu, sigma);
  for (i in 1:Nobs){
    temp2[1] = -conc[year[i]]*Search[i];
    temp2[2] = log1m_exp(-conc[year[i]]*Search[i])+log(1-0.31);
    target += y[i]*(log1m_exp(-conc[year[i]]*Search[i]) + log(0.31)) +
              (1-y[i])*log_sum_exp(temp2);
  }
}
"


stan_in2 <- function(data = Bernoulli_Bernoulli_Mixture_Model_Data, chains = nchains){
    y <- data$Catch
    n <- length(y)
    year <- as.numeric(ordered(data$Year))
    nyear <- max(year)
    stan_data <- list(Nobs = n, Nyear = nyear,
                      year = year, Search = data$EFFHA,
                      y=y)
    stan_inits <- list()
    for (i in 1:chains)
        stan_inits[[i]] <- list(lconc=rnorm(nyear, -2),
                                mu=rnorm(1, -2),
                                sigma=runif(1))
    stan_pars <- c("lconc", "mu", "sigma")
    return(list(data = stan_data, inits = stan_inits,
                pars = stan_pars, n.chains = chains))
}

fit_Bernoulli_Bernoulli_Mixture_Model <- stan_model(model_code = Bernoulli_Bernoulli_Mixture_Model)

input.to.stan <- stan_in2(Bernoulli_Bernoulli_Mixture_Model_Data)
fit2keep_Bernoulli_Bernoulli_Mixture_Model <- sampling(fit_Bernoulli_Bernoulli_Mixture_Model, data = input.to.stan$data,
                     init = input.to.stan$inits,
                     pars = input.to.stan$pars,
                     iter = niters,thin=nthin,
                     chains = input.to.stan$n.chains)


# Build Bernoulli-Bernoulli recruitment table with Rank/Index and convergence diagnostics
Recruitment_Bernoulli_Bernoulli <- (function(fit, dat){
  yrs  <- sort(unique(dat$Year))
  S    <- rstan::extract(fit, pars = "lconc", permute = TRUE)$lconc
  summ <- as.data.frame(rv::as.rvsummary(rv::rvsims(exp(S))))
  summ <- summ[, setdiff(names(summ), "sims"), drop = FALSE]

  # pick the median column
  med_col <- intersect(c("median","50%","q50","Error_50"), names(summ))[1]
  med     <- as.numeric(summ[[med_col]])

  q75  <- quantile(med, 0.75, na.rm = TRUE)
  q25  <- quantile(med, 0.25, na.rm = TRUE)
  Rank <- dplyr::dense_rank(-med)  
  Index <- ifelse(med >= q75, "Good", ifelse(med <= q25, "Poor", "Fair"))

  diag <- as.data.frame(rstan::summary(fit, pars = "lconc")$summary)[, c("n_eff","Rhat")]
  diag$n_eff <- as.integer(round(diag$n_eff))
  diag$Rhat  <- as.integer(round(diag$Rhat))

  cbind(summ, Year = yrs, Rank, Index, diag)
})(fit2keep_Bernoulli_Bernoulli_Mixture_Model, Bernoulli_Bernoulli_Mixture_Model_Data)

Recruitment_Bernoulli_Bernoulli

```